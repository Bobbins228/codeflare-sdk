<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running e2e tests locally &mdash; CodeFlare SDK v0.21.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=cbab269b"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="S3 compatible storage with Ray Train examples" href="s3-compatible-storage.html" />
    <link rel="prev" title="Ray Cluster Interaction" href="ray-cluster-interaction.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CodeFlare SDK
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Code Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">codeflare_sdk</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Documentation:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="authentication.html">Authentication via the CodeFlare SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="cluster-configuration.html">Ray Cluster Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="ray-cluster-interaction.html">Ray Cluster Interaction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running e2e tests locally</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pre-requisites">Pre-requisites</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#on-kind-clusters">On KinD clusters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#on-openshift-clusters">On OpenShift clusters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#on-openshift-disconnected-clusters">On OpenShift Disconnected clusters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="s3-compatible-storage.html">S3 compatible storage with Ray Train examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup-kueue.html">Basic Kueue Resources configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="ui-widgets.html">Jupyter UI Widgets</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CodeFlare SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Running e2e tests locally</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user-docs/e2e.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="running-e2e-tests-locally">
<h1>Running e2e tests locally<a class="headerlink" href="#running-e2e-tests-locally" title="Link to this heading"></a></h1>
<section id="pre-requisites">
<h2>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>We recommend using Python 3.9, along with Poetry.</p></li>
</ul>
<section id="on-kind-clusters">
<h3>On KinD clusters<a class="headerlink" href="#on-kind-clusters" title="Link to this heading"></a></h3>
<p>Pre-requisite for KinD clusters: please add in your local <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code>
file <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span> <span class="pre">kind</span></code>. This will map your localhost IP address to the
KinD cluster’s hostname. This is already performed on <a class="reference external" href="https://github.com/project-codeflare/codeflare-common/blob/1edd775e2d4088a5a0bfddafb06ff3a773231c08/github-actions/kind/action.yml#L70-L72">GitHub
Actions</a></p>
<p>If the system you run on contains NVidia GPU then you can enable the GPU
support in KinD, this will allow you to run also GPU tests. To enable
GPU on KinD follow <a class="reference external" href="https://www.substratus.ai/blog/kind-with-gpus">these
instructions</a>.</p>
<ul>
<li><p>Setup Phase:</p>
<ul class="simple">
<li><p>Pull the <a class="reference external" href="https://github.com/project-codeflare/codeflare-operator">codeflare-operator
repo</a>
and run the following make targets:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>make kind-e2e
export CLUSTER_HOSTNAME=kind
make setup-e2e
make deploy -e IMG=quay.io/project-codeflare/codeflare-operator:v1.3.0

For running tests locally on Kind cluster, we need to disable `rayDashboardOAuthEnabled` in `codeflare-operator-config` ConfigMap and then restart CodeFlare Operator
</pre></div>
</div>
<ul class="simple">
<li><p><strong>(Optional)</strong> - Create and add <code class="docutils literal notranslate"><span class="pre">sdk-user</span></code> with limited
permissions to the cluster to run through the e2e tests:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Get KinD certificates
docker cp kind-control-plane:/etc/kubernetes/pki/ca.crt .
docker cp kind-control-plane:/etc/kubernetes/pki/ca.key .

# Generate certificates for new user
openssl genrsa -out user.key 2048
openssl req -new -key user.key -out user.csr -subj &#39;/CN=sdk-user/O=tenant&#39;
openssl x509 -req -in user.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out user.crt -days 360

# Add generated certificated to KinD context
user_crt=$(base64 --wrap=0 user.crt)
user_key=$(base64 --wrap=0 user.key)
yq eval -i &quot;.contexts += {\&quot;context\&quot;: {\&quot;cluster\&quot;: \&quot;kind-kind\&quot;, \&quot;user\&quot;: \&quot;sdk-user\&quot;}, \&quot;name\&quot;: \&quot;sdk-user\&quot;}&quot; $HOME/.kube/config
yq eval -i &quot;.users += {\&quot;name\&quot;: \&quot;sdk-user\&quot;, \&quot;user\&quot;: {\&quot;client-certificate-data\&quot;: \&quot;$user_crt\&quot;, \&quot;client-key-data\&quot;: \&quot;$user_key\&quot;}}&quot; $HOME/.kube/config
cat $HOME/.kube/config

# Cleanup
rm ca.crt
rm ca.srl
rm ca.key
rm user.crt
rm user.key
rm user.csr

# Add RBAC permissions to sdk-user
kubectl create clusterrole list-ingresses --verb=get,list --resource=ingresses
kubectl create clusterrolebinding sdk-user-list-ingresses --clusterrole=list-ingresses --user=sdk-user
kubectl create clusterrole appwrapper-creator --verb=get,list,create,delete,patch --resource=appwrappers
kubectl create clusterrolebinding sdk-user-appwrapper-creator --clusterrole=appwrapper-creator --user=sdk-user
kubectl create clusterrole namespace-creator --verb=get,list,create,delete,patch --resource=namespaces
kubectl create clusterrolebinding sdk-user-namespace-creator --clusterrole=namespace-creator --user=sdk-user
kubectl create clusterrole list-rayclusters --verb=get,list --resource=rayclusters
kubectl create clusterrolebinding sdk-user-list-rayclusters --clusterrole=list-rayclusters --user=sdk-user
kubectl config use-context sdk-user
</pre></div>
</div>
<ul class="simple">
<li><p>Install the latest development version of kueue</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">--</span><span class="n">server</span><span class="o">-</span><span class="n">side</span> <span class="o">-</span><span class="n">k</span> <span class="s2">&quot;github.com/opendatahub-io/kueue/config/rhoai?ref=dev&quot;</span>
</pre></div>
</div>
</li>
<li><p>Test Phase:</p>
<ul class="simple">
<li><p>Once we have the codeflare-operator, kuberay-operator and kueue
running and ready, we can run the e2e test on the codeflare-sdk
repository:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poetry</span> <span class="n">install</span> <span class="o">--</span><span class="k">with</span> <span class="n">test</span><span class="p">,</span><span class="n">docs</span>
<span class="n">poetry</span> <span class="n">run</span> <span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">s</span> <span class="o">./</span><span class="n">tests</span><span class="o">/</span><span class="n">e2e</span><span class="o">/</span><span class="n">mnist_raycluster_sdk_kind_test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If the cluster doesn’t have NVidia GPU support then we need to
disable NVidia GPU tests by providing proper marker:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poetry</span> <span class="n">install</span> <span class="o">--</span><span class="k">with</span> <span class="n">test</span><span class="p">,</span><span class="n">docs</span>
<span class="n">poetry</span> <span class="n">run</span> <span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">s</span> <span class="o">./</span><span class="n">tests</span><span class="o">/</span><span class="n">e2e</span><span class="o">/</span><span class="n">mnist_raycluster_sdk_kind_test</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">m</span> <span class="s1">&#39;kind and not nvidia_gpu&#39;</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="on-openshift-clusters">
<h3>On OpenShift clusters<a class="headerlink" href="#on-openshift-clusters" title="Link to this heading"></a></h3>
<ul>
<li><p>Setup Phase:</p>
<ul class="simple">
<li><p>Pull the <a class="reference external" href="https://github.com/project-codeflare/codeflare-operator">codeflare-operator
repo</a>
and run the following make targets:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">setup</span><span class="o">-</span><span class="n">e2e</span>
<span class="n">make</span> <span class="n">deploy</span> <span class="o">-</span><span class="n">e</span> <span class="n">IMG</span><span class="o">=</span><span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">project</span><span class="o">-</span><span class="n">codeflare</span><span class="o">/</span><span class="n">codeflare</span><span class="o">-</span><span class="n">operator</span><span class="p">:</span><span class="n">v1</span><span class="mf">.3.0</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Install the latest development version of kueue</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">--</span><span class="n">server</span><span class="o">-</span><span class="n">side</span> <span class="o">-</span><span class="n">k</span> <span class="s2">&quot;github.com/opendatahub-io/kueue/config/rhoai?ref=dev&quot;</span>
</pre></div>
</div>
</li>
</ul>
<p>If the system you run on contains NVidia GPU then you can enable the GPU
support on OpenShift, this will allow you to run also GPU tests. To
enable GPU on OpenShift follow <a class="reference external" href="https://docs.nvidia.com/datacenter/cloud-native/openshift/latest/introduction.html">these
instructions</a>.
Currently the SDK doesn’t support tolerations, so e2e tests can’t be
executed on nodes with taint (i.e. GPU taint).</p>
<ul>
<li><p>Test Phase:</p>
<ul class="simple">
<li><p>Once we have the codeflare-operator, kuberay-operator and kueue
running and ready, we can run the e2e test on the codeflare-sdk
repository:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poetry</span> <span class="n">install</span> <span class="o">--</span><span class="k">with</span> <span class="n">test</span><span class="p">,</span><span class="n">docs</span>
<span class="n">poetry</span> <span class="n">run</span> <span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">s</span> <span class="o">./</span><span class="n">tests</span><span class="o">/</span><span class="n">e2e</span><span class="o">/</span><span class="n">mnist_raycluster_sdk_test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To run the multiple tests based on the cluster environment, we can
run the e2e tests by marking -m with cluster environment (kind or
openshift)</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poetry</span> <span class="n">run</span> <span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">s</span> <span class="o">./</span><span class="n">tests</span><span class="o">/</span><span class="n">e2e</span> <span class="o">-</span><span class="n">m</span> <span class="n">openshift</span>
</pre></div>
</div>
<ul class="simple">
<li><p>By default tests configured with timeout of <code class="docutils literal notranslate"><span class="pre">15</span> <span class="pre">minutes</span></code>. If
necessary, we can override the timeout using <code class="docutils literal notranslate"><span class="pre">--timeout</span></code> option</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poetry</span> <span class="n">run</span> <span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">s</span> <span class="o">./</span><span class="n">tests</span><span class="o">/</span><span class="n">e2e</span> <span class="o">-</span><span class="n">m</span> <span class="n">openshift</span> <span class="o">--</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1200</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="on-openshift-disconnected-clusters">
<h3>On OpenShift Disconnected clusters<a class="headerlink" href="#on-openshift-disconnected-clusters" title="Link to this heading"></a></h3>
<ul>
<li><p>In addition to setup phase mentioned above in case of Openshift
cluster, Disconnected environment requires following pre-requisites :</p>
<ul>
<li><p>Mirror Image registry :</p>
<ul class="simple">
<li><p>Image mirror registry is used to host set of container images
required locally for the applications and services. This
ensures to pull images without needing an external network
connection. It also ensures continuous operation and deployment
capabilities in a network-isolated environment.</p></li>
</ul>
</li>
<li><p>PYPI Mirror Index :</p>
<ul class="simple">
<li><p>When trying to install Python packages in a disconnected
environment, the pip command might fail because the connection
cannot install packages from external URLs. This issue can be
resolved by setting up PIP Mirror Index on separate endpoint in
same environment.</p></li>
</ul>
</li>
<li><p>S3 compatible storage :</p>
<ul>
<li><p>Some of our distributed training examples require an external
storage solution so that all nodes can access the same data in
disconnected environment (For example: common-datasets and
model files).</p></li>
<li><p>Minio S3 compatible storage type instance can be deployed in
disconnected environment using
<code class="docutils literal notranslate"><span class="pre">/tests/e2e/minio_deployment.yaml</span></code> or using support methods
in e2e test suite.</p></li>
<li><p>The following are environment variables for configuring PIP
index URl for accessing the common-python packages required and
the S3 or Minio storage for your Ray Train script or
interactive session.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">RAY_IMAGE</span><span class="o">=</span><span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">project</span><span class="o">-</span><span class="n">codeflare</span><span class="o">/</span><span class="n">ray</span><span class="nd">@sha256</span><span class="p">:</span><span class="o">&lt;</span><span class="n">image</span><span class="o">-</span><span class="n">digest</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">prefer</span> <span class="n">image</span> <span class="n">digest</span> <span class="n">over</span> <span class="n">image</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">disocnnected</span> <span class="n">environment</span><span class="p">)</span>
<span class="n">PIP_INDEX_URL</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">bastion</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">endpoint</span><span class="o">-</span><span class="n">url</span><span class="o">&gt;/</span><span class="n">root</span><span class="o">/</span><span class="n">pypi</span><span class="o">/+</span><span class="n">simple</span><span class="o">/</span> \
<span class="n">PIP_TRUSTED_HOST</span><span class="o">=&lt;</span><span class="n">bastion</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">endpoint</span><span class="o">-</span><span class="n">url</span><span class="o">&gt;</span> \
<span class="n">AWS_DEFAULT_ENDPOINT</span><span class="o">=&lt;</span><span class="n">s3</span><span class="o">-</span><span class="n">compatible</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">endpoint</span><span class="o">-</span><span class="n">url</span><span class="o">&gt;</span> \
<span class="n">AWS_ACCESS_KEY_ID</span><span class="o">=&lt;</span><span class="n">s3</span><span class="o">-</span><span class="n">compatible</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">key</span><span class="o">&gt;</span>  \
<span class="n">AWS_SECRET_ACCESS_KEY</span><span class="o">=&lt;</span><span class="n">s3</span><span class="o">-</span><span class="n">compatible</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">key</span><span class="o">&gt;</span>  \
<span class="n">AWS_STORAGE_BUCKET</span><span class="o">=&lt;</span><span class="n">storage</span><span class="o">-</span><span class="n">bucket</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
<span class="n">AWS_STORAGE_BUCKET_MNIST_DIR</span><span class="o">=&lt;</span><span class="n">storage</span><span class="o">-</span><span class="n">bucket</span><span class="o">-</span><span class="n">MNIST</span><span class="o">-</span><span class="n">datasets</span><span class="o">-</span><span class="n">directory</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using the Python Minio client to connect to a minio
storage bucket, the <code class="docutils literal notranslate"><span class="pre">AWS_DEFAULT_ENDPOINT</span></code> environment
variable by default expects secure endpoint where user can use
endpoint url with https/http prefix for autodetection of
secure/insecure endpoint.</p>
</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ray-cluster-interaction.html" class="btn btn-neutral float-left" title="Ray Cluster Interaction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="s3-compatible-storage.html" class="btn btn-neutral float-right" title="S3 compatible storage with Ray Train examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Project CodeFlare.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>